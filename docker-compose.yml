version: '3.8'

services:
  # Scry Ingestor API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    env_file:
      - .env
    ports:
      - "8000:8000"
    environment:
      SCRY_LOG_LEVEL: ${SCRY_LOG_LEVEL:-INFO}
      SCRY_AWS__REGION: ${SCRY_AWS__REGION:-us-east-1}
    volumes:
      - ./config:/app/config:ro
      - ./tests/fixtures:/app/fixtures:ro
    depends_on:
      - redis
      - postgres
    networks:
      - scry-network
    restart: unless-stopped
    labels:
      - "prometheus.io/scrape=true"
      - "prometheus.io/path=/metrics"
      - "prometheus.io/port=8000"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import sys, urllib.request, socket; from urllib.error import URLError, HTTPError; url='http://127.0.0.1:8000/health';\\ntry:\\n    with urllib.request.urlopen(url, timeout=5) as response:\\n        sys.exit(0 if response.status == 200 else 1)\\nexcept (URLError, HTTPError, socket.timeout):\\n    sys.exit(1)\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis for Celery broker
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - scry-network
    restart: unless-stopped

  # PostgreSQL for metadata storage
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-scry_ingestor}
      POSTGRES_USER: ${POSTGRES_USER:-scry}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD not set}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - scry-network
    restart: unless-stopped

  # Celery worker for async tasks
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
      target: celery-worker
    env_file:
      - .env
    environment:
      SCRY_LOG_LEVEL: ${SCRY_LOG_LEVEL:-INFO}
      SCRY_REDIS_URL: ${SCRY_REDIS_URL:-redis://redis:6379/0}
      SCRY_AWS__REGION: ${SCRY_AWS__REGION:-us-east-1}
    volumes:
      - ./config:/app/config:ro
      - ./tests/fixtures:/app/fixtures:ro
    depends_on:
      - redis
      - postgres
    networks:
      - scry-network
    restart: unless-stopped

networks:
  scry-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
